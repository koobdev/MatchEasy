<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="/include/head.html">
    <title>TITLE</title>
</head>
<body>
<div th:include="/include/header.html"></div>

<div data-uk-height-viewport="expand: true">
    <div class="uk-container uk-container-expand">
        <div class="uk-card-body">
            <div class="uk-text-left uk-margin-small uk-margin-large-left">
                <button class="uk-button uk-button-primary" uk-toggle="target: #registerForm">게시글 작성</button>
            </div><br/><br/>

            <div class="uk-grid uk-child-width-1-2@s uk-child-width-1-3@m uk-child-width-1-4@l uk-child-width-1-5@xl uk-grid-match uk-sortable"
                        id="boardList">
                <div class="board-card">
                    <div class="uk-card uk-card-default">
                        <div class="uk-card-header">
                            <div class="uk-text-right uk-margin-bottom">
                                <button class="uk-button uk-button-small uk-text-nowrap">모집중</button>
                            </div>
                            <div class="uk-width-expand">
                                <p class="uk-text-small" id="title" >프로젝트 팀원 모집합니다.(test)</p>
                            </div>
                        </div>
                        <div class="uk-card-body">
                            <p id="content uk-text-nowrap">웹 개발자 스터디 함께 하실분을 모집합니다.</p>
                            <p class="uk-text-small uk-text-nowrap" id="date">2022-03-01 ~ 2022-03-31</p>
                        </div>
                        <div class="uk-card-footer">
                            <div class="uk-width-auto">
                                <img th:src="@{/static/image/java.png}">
                                <img th:src="@{/static/image/spring.png}">
                                <img th:src="@{/static/image/react.png}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="board-card">
                    <div class="uk-card uk-card-default" >
                        <div class="uk-card-header">
                            <div class="uk-text-right uk-margin-bottom">
                                <button class="uk-button uk-button-danger uk-button-small uk-text-nowrap">모집완료</button>
                            </div>
                            <div class="uk-width-expand">
                                <p class="uk-text-small">프로젝트 팀원 모집합니다.(test)</p>
                            </div>
                        </div>
                        <div class="uk-card-body">
                            <p class="uk-text-nowrap">스터디 함께 하실분!!!!!</p>
                            <p class="uk-text-small uk-text-nowrap">2022-02-01 ~ 2022-02-28</p>

                        </div>
                        <div class="uk-card-footer">
                            <div class="uk-width-auto">
                                <img th:src="@{/static/image/java.png}">
                                <img th:src="@{/static/image/spring.png}">
                                <img th:src="@{/static/image/react.png}">
                            </div>
                        </div>
                    </div>
                </div>

                <div>

                </div>
            </div>


            <div id="registerForm" class="uk-modal-container" uk-modal>
                <div class="uk-modal-dialog">
                    <button class="uk-modal-close-default uk-text-right" type="button" uk-close></button>
                    <div class="uk-modal-header uk-margin-small">
                        <p class="uk-modal-title">게시글 작성하기</p>
                    </div>
                    <div class="uk-modal-body">
                        <table class="uk-table uk-text-center">
                            <tr>
                                <th>제목</th>
                                <td>
                                    <input class="uk-input uk-form-width-xlarge uk-form-small" id="registerTitle"
                                           type="text" placeholder="제목을 입력하세요." />
                                </td>
                            </tr>
                            <tr>
                                <th>내용</th>
                                <td>
                                    <textarea class="uk-textarea uk-height-small uk-margin-remove" id="registerContent"
                                              placeholder="내용을 입력하세요." ></textarea>
                                </td>
                            </tr>
                            <tr>
                                <th>모집 일자</th>
                                <td>
                                    <div class="uk-form-controls uk-margin-small-top">
                                        <div data-uk-grid>
                                            <div>
                                                <input class="uk-input uk-form-small" id="startDate"
                                                       name="startDate" type="text" placeholder="시작일자"  />
                                            </div>
                                            <div>
                                                <span>~</span>
                                            </div>
                                            <div>
                                                <input class="uk-input uk-form-small" id="endDate"
                                                       name="endDate" type="text" placeholder="종료일자"  />
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr><th></th><td></td></tr>
                            <tr>
                                <th>
                                    모집 포지션<br>
                                    <span class="uk-margin-remove" uk-icon="icon: plus-circle"
                                          onclick="addPositionOption()"></span>
                                    <span class="uk-margin-remove" uk-icon="icon: minus-circle"
                                          onclick="removePositionOption()"></span>
                                </th>
                                <td id="positions">
                                    <div data-uk-grid="true">
                                        <div class="uk-width-auto">
                                            <span>포지션 명</span>
                                            <input class="uk-input uk-form-small"
                                                   type="text" placeholder="포지션 명을 입력하세요." />
                                        </div>
                                        <div class="uk-width-expand">
                                            <span>설명 기입</span>
                                            <input class="uk-input uk-form-width-xlarge uk-form-small"
                                                   type="text" placeholder="간단한 역할과 같은 것을 입력하세요." />
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <div class="uk-text-right uk-margin-medium-top" id="btnRegister">
                            <button class="uk-button uk-button-primary uk-button-radius"
                                    onClick="registerBoardContent()">등록
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>

    const startDate = flatpickr("#startDate", {
        altInput: true,
        altFormat: "Y년 m월 d일",
        locale: "ko"
    });

    const endDate = flatpickr("#endDate", {
        altInput: true,
        altFormat: "Y년 m월 d일",
        locale: "ko"
    });


    let accessToken = storage.get("accessToken");
    let url = "http://localhost:8080/board/list";
    let xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
    xhr.responseType = 'json';
    xhr.send();

    xhr.onreadystatechange = function () {
        if(xhr.readyState === 4 && xhr.status === 200) {
            let data = xhr.response;
            console.log(data);

            let boardList = document.getElementById("boardList");
            let tbody = "";
            for (const content of data) {
                tbody += makeBoardContentDiv(content);
            }
            boardList.innerHTML = tbody;

        }else if(xhr.readyState === 4 && xhr.status === 401){
            reIssueToken();
        }else {
            UIkit.modal.alert(xhr.response.message).then(function () {
                window.location.href = "/main";
            });
        }
    };



    function addPositionOption() {
        let position = document.getElementById("positions");

        let div = document.createElement('div');
        div.setAttribute('data-uk-grid', 'true');


        let divAuto = document.createElement('div');
        divAuto.setAttribute('class', 'uk-width-auto');

        let spanAuto = document.createElement('span');
        let spanAutoText = document.createTextNode('포지션 명');
        spanAuto.appendChild(spanAutoText);

        let inputAuto = document.createElement('input');
        inputAuto.setAttribute('class', 'uk-input uk-form-width-xlarge uk-form-small');
        inputAuto.setAttribute('type', 'text');
        inputAuto.setAttribute('placeholder', '포지션 명을 입력하세요.');

        divAuto.appendChild(spanAuto);
        divAuto.appendChild(inputAuto);



        let divExpand = document.createElement('div');
        divExpand.setAttribute('class', 'uk-width-expand');

        let spanExpand = document.createElement('span');
        let spanExpandText = document.createTextNode('설명 기입');
        spanExpand.appendChild(spanExpandText);

        let inputExpand = document.createElement('input');
        inputExpand.setAttribute('class', 'uk-input uk-form-small');
        inputExpand.setAttribute('type', 'text');
        inputExpand.setAttribute('placeholder', '간단한 역할과 같은 것을 입력하세요.');

        divExpand.appendChild(spanExpand);
        divExpand.appendChild(inputExpand);


        div.appendChild(divAuto);
        div.appendChild(divExpand);
        position.appendChild(div);
    }

    function removePositionOption() {
        let position = document.getElementById("positions");
        if(position.childElementCount != 1){
            position.removeChild(position.lastChild);
        }else {
            UIkit.modal.alert('최소 한개 이상의 포지션이 있어야 합니다.').then(function () {
            });
        }
    }


    function registerBoardContent() {
        let userId = storage.get("userId");
        let title = document.getElementById('registerTitle').value;
        let content = document.getElementById('registerContent').value;
        let startDate = document.getElementById('startDate').value;
        let endDate = document.getElementById('endDate').value;
        let positionList = [];
        let url = "http://localhost:8080/board/register";

        let position = document.getElementById("positions");
        let childLen = position.children.length;
        for(let i=0; i<childLen; i++){
            let positionTitle = position.children[i].children[0].children[1].value;
            let positionContent = position.children[i].children[1].children[1].value;
            let positionElement = {
                "position" : positionTitle,
                "content" : positionContent,
                "status" : 0
            };
            positionList.push(positionElement);
        }

        let target = {
            "title" : title,
            "content" : content,
            "positions" : positionList,
            "startdate" : valueToTimeStamp.getDate(startDate),
            "enddate" : valueToTimeStamp.getDate(endDate),
            "regdate": "",
            "moddate": "",
            "writerId": userId
        }

        xhr.open('POST', url);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
        xhr.responseType = 'json';
        xhr.send(JSON.stringify(target));

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                let data = xhr.response;
                console.log(data);

                UIkit.modal.alert(xhr.response.message).then(function () {
                    window.location.href = "/main";
                });

            }else if(xhr.readyState === 4 && xhr.status === 401){
                reIssueToken();
            }else {
                UIkit.modal.alert(xhr.response.message).then(function () {
                    window.location.href = "/main";
                });
            }
        }
    }

    function openDetail(id) {
        storage.set("contentDetail", id);
        window.location.href = "/form/contentDetail";
    }
</script>